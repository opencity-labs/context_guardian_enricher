<p align="center">
    <img src="context_guardian_enricher.png" alt="Context Guardian and Enricher Logo" width="50" style="border-radius: 50%; vertical-align: middle; margin-right: 10px;" />
    <span style="font-size:2em; vertical-align: middle;"><b>Context Guardian & Enricher</b></span>
</p>

[![CheshireCat AI Plugin - Context Guardian & Enricher](https://custom-icon-badges.demolab.com/static/v1?label=&message=awesome+plugin&color=F4F4F5&style=for-the-badge&logo=cheshire_cat_black)](https://)

Intelligently guard your AI conversations by ensuring responses stay within your knowledge base while enriching messages with source links and UTM tracking!

## Description

**Context Guardian & Enricher** is a plugin for Cheshire Cat AI that ensures that the AI only responds to queries that have relevant context in the knowledge base, while automatically enriching responses with source citations and UTM tracking for analytics.

The plugin provides four core functionalities:
1. **Context Guardian**: Rejects queries that have no relevant context in the declarative memory
2. **Source Enricher**: Automatically appends sources to responses with optional UTM tracking to ALL the links
3. **Panic Button**: Emergency mode that always returns a predefined message regardless of context
4. **Time Awareness**: Adds current timestamp to user messages for temporal context

## Features

- Automatically rejects out-of-context queries that have no relevant information in the knowledge base and answer with a predefined message
- Bypasse all the checks when users are in active form sessions
- Emergency override that always returns a predefined maintenance message
- Append relevant source URLs and titles to the `message.sources` parameter as a list `(url, title)`
- Customizable UTM parameters to all outgoing links for analytics tracking to all URLs in the `message.text` other than the sources
- Append current timestamp to user messages

## Requirements

- Cheshire Cat AI
- Context Guardian & Enricher plugin enabled in Cheshire Cat AI

## Settings

- **`double_pass`**: *(Boolean, default: False)* - It combines user input with generated response for more precise source selection. When enabled, only sources that appear in both the initial query results and the post-response query are included.

- **`default_message`**: *(Text Area, default: "Sorry, I can't help you. To answer adequately: • Write short, complete sentences • Express one request at a time")* - The message returned when no relevant context is found in the knowledge base.

- **`min_query_length`**: *(int, default: 10)* - Minimum number of characters a query must have to be accepted for processing.

- **`panic_button_enabled`**: *(Boolean, default: False)* - Enable panic button mode that always returns the panic button text regardless of context or available knowledge. When enabled, takes priority over all other functionality.

- **`panic_button_text`**: *(Text Area, default: "Sorry, I'm under maintenance right now. Please try again later.")* - The message returned when panic button mode is enabled.

- **`utm_source`**: *(String, default: "")* - UTM source parameter to add to all outgoing links for tracking purposes. Leave empty to disable UTM tracking entirely. This parameter is added to both source citations in `message.sources` and any URL generated by the LLM in `message.text`.

## Technical Details

### Hooks Used

- **`fast_reply`**: Intercepts queries early to check for relevant context before engaging the LLM
- **`before_cat_reads_message`**: Adds current timestamp to user messages
- **`before_cat_sends_message`**: Enriches outgoing messages with sources and UTM tracking

---

Author: OpenCity Labs

LinkedIn: https://www.linkedin.com/company/opencity-italia/